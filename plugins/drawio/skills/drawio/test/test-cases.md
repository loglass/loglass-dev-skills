# drawio スキル 動作確認テストケース

## 1. 作成・編集ワークフロー

> **共通前提**: 作成・編集の全ケースで、参照ファイル（xml-reference.md, layout-guide.md）を **両方読み込んでから** 作業を開始していることを確認する。

### 1-1. 新規ドメインモデル図の作成（複数集約・コンポジション・集約間参照）

- **入力**: 「注文集約（注文→注文明細）、顧客集約（顧客→配送先）、商品集約（商品）のドメインモデル図を作って。集約ごとにグルーピングして、注文→顧客、注文明細→商品の参照関係も表現して」
- **確認ポイント**:
  - 参照ファイル（xml-reference.md, layout-guide.md）を両方読み込んでから作業を開始しているか
  - 要件確認のやり取りが発生するか
  - `Glob` で既存 `.drawio` を検索しているか
  - 既存ファイルがない場合、`Write` で新規作成しているか
  - 生成された XML が基本構造テンプレートに準拠しているか
  - `darkMode="0"` が指定されているか
  - **グルーピング**: 集約ごとに swimlane でグループ化されているか。子要素の `parent` がグループ ID を指しているか
  - **コンポジション**: 注文→注文明細、顧客→配送先が `diamondThin` + `startFill=1` で表現されているか。◆が親側（注文、顧客）に配置されているか
  - **集約間参照**: 注文→顧客、注文明細→商品が点線（`dashed=1`）で表現されているか
  - **レイアウト**: 親子関係が縦配置、集約間参照が横方向になっているか
  - **エッジの分岐**: 注文から顧客への参照と、注文明細から商品への参照が交差せず分散されているか

### 1-2. 新規 ER 図の作成（Stack Layout）

- **入力**: 「ユーザー、注文、商品の3テーブルで ER 図を作って」
- **確認ポイント**:
  - 参照ファイル（xml-reference.md, layout-guide.md）を両方読み込んでから作業を開始しているか
  - Stack Layout（UML Class 形式）が使われているか
  - ヘッダー高さ = `startSize`（30px）
  - 各行 = 30px
  - 全体の高さ = startSize + (行数 x 30) が正しく計算されているか
  - テーブル間のリレーションが適切なエッジスタイルで表現されているか

### 1-3. 既存図へのエンティティ追加

- **前提**: 1-1 で作成した `.drawio` ファイルが存在する
- **入力**: 「ドメインモデル図に Product エンティティを追加して」
- **確認ポイント**:
  - 参照ファイル（xml-reference.md, layout-guide.md）を両方読み込んでから作業を開始しているか
  - `Glob` で既存ファイルを発見しているか
  - `Read` で既存 XML を取得し、既存 ID を確認しているか
  - 新しい ID が既存 ID と重複していないか
  - `Edit` ツールで部分的に XML を更新しているか（`Write` で全体上書きではなく）
  - 追加要素のレイアウトが既存要素と重ならないか

### 1-4. 既存図へのエッジ追加

- **前提**: 1-3 で Product エンティティが追加済み
- **入力**: 「注文と商品の間にリレーションを追加して」
- **確認ポイント**:
  - 参照ファイル（xml-reference.md, layout-guide.md）を両方読み込んでから作業を開始しているか
  - source/target の指定が正しいか
  - 矢印スタイルが適切か（composition の場合、`diamondThin` が親側に配置されているか）
  - `exitX`/`exitY`/`entryX`/`entryY` で接続ポイントが指定されているか

### 1-5. 複数ページの図の作成

- **入力**: 「概要ページと詳細ページの2ページ構成でアーキテクチャ図を作って」
- **確認ポイント**:
  - 参照ファイル（xml-reference.md, layout-guide.md）を両方読み込んでから作業を開始しているか
  - `<diagram>` タグが2つ生成されているか
  - 各 `<mxGraphModel>` に `darkMode="0"` が付与されているか
  - 各ページに適切な `name` と一意な `id` が設定されているか

### 1-6. 編集後にファイルを自動で開かないこと

- **前提**: 1-3 または 1-4 の編集を実施
- **確認ポイント**:
  - 編集完了後に `open -a "draw.io"` が実行されていないか
  - ファイルパスの表示のみで完了しているか

## 2. 読み込みワークフロー

### 2-1. 既存ドメインモデル図の読み込み

- **前提**: `.drawio` ファイルが存在する
- **入力**: 「ドメインモデルを確認して」
- **確認ポイント**:
  - **xml-reference.md を Glob より先に読み込んでいるか**（手順1 → 手順2 の順序）
  - `Glob` で `.drawio` ファイルを検索 → `Read` で XML を読み込みの順で実行されているか
  - `value` 属性からエンティティ名を抽出しているか
  - `source`/`target` からリレーションを抽出しているか
  - 構造化されたサマリとして出力されているか

### 2-2. 複雑な図の読み込み

- **前提**: 多数のエンティティ・エッジ・グループを含む `.drawio` ファイル（1-5 で作成した複数ページのアーキテクチャ図、または別途用意した swimlane 付きの図）
- **入力**: 「アーキテクチャ図を確認して、依存関係を教えて」
- **確認ポイント**:
  - レイヤー構造（swimlane のグループ）が正しく読み取れるか
  - `fillColor` から要素の分類が判別されているか
  - `parent` 属性からグループの親子関係が復元されているか

### 2-3. カスタムプロパティ付き図の読み込み

- **前提**: `<object>` タグでカスタムプロパティが設定された `.drawio` ファイル。テスト用に以下のような XML を含むファイルを用意する:
  ```xml
  <object label="DBサーバー" zone="3" type="database" id="db1">
    <mxCell style="shape=cylinder3;..." vertex="1" parent="1">
      <mxGeometry x="100" y="100" width="60" height="80" as="geometry" />
    </mxCell>
  </object>
  ```
- **入力**: 「この図に何が書いてある？」
- **確認ポイント**:
  - `<object>` タグの属性（zone, type など）が抽出されているか
  - カスタムプロパティの情報がサマリに含まれているか

## 3. 開くワークフロー

### 3-1. デスクトップアプリで開く

- **前提**: draw.io デスクトップアプリがインストール済み
- **入力**: 「このファイルを開いて」（`.drawio` ファイルを指定）
- **確認ポイント**:
  - `open -a "draw.io" <ファイルパス>` が実行されるか
  - draw.io アプリでファイルが表示されるか

### 3-2. draw.io 未インストール時

- **前提**: draw.io デスクトップアプリが未インストール（`brew uninstall --cask drawio` で一時的にアンインストールするか、未インストールの環境で実施）
- **入力**: 「.drawio ファイルを開いて」
- **確認ポイント**:
  - エラーメッセージが適切に表示されるか
  - `brew install --cask drawio` のインストール案内があるか

## 4. スキル発動境界

### 4-1. Mermaid への非発動

- **入力**: 「Mermaid でフローチャートを書いて」
- **確認ポイント**:
  - drawio スキルが発動 **しない** こと
  - Mermaid 記法で出力されるか、または別の対応がされるか

### 4-2. PlantUML への非発動

- **入力**: 「PlantUML でクラス図を書いて」
- **確認ポイント**:
  - drawio スキルが発動 **しない** こと

### 4-3. 対応リスト外の図への対応

- **入力**: 「ガントチャートを draw.io で作って」
- **確認ポイント**:
  - 対応図の種類リストに含まれていないが、「上記以外も対応可能」の記載に従い対応するか
  - draw.io で表現可能な形で生成されるか

### 4-4. オブジェクト図での発動

- **入力**: 「オブジェクト図を作って」
- **確認ポイント**:
  - description に「オブジェクト図」が含まれているため、drawio スキルが発動するか
  - ドメインモデルの具体例として適切な図が生成されるか

## 5. 参照ファイル準拠（xml-reference.md / layout-guide.md）

### 5-1. カラーパレットの準拠

- **入力**: 「プレゼンテーション層、ユースケース層、ドメイン層、インフラ層の4層アーキテクチャ図を作って」
- **確認ポイント**:
  - 使用されている fillColor / strokeColor が xml-reference.md のカラーパレット（青・緑・黄・オレンジ・紫・赤・グレーの7色）に含まれているか
  - 色の使い分けが意味に沿っているか（例: ドメイン層=青、インフラ層=緑）

### 5-2. エッジラベルの生成

- **入力**: 「注文と顧客の間に『1対多』のラベル付きリレーションを作って」
- **確認ポイント**:
  - エッジラベル用の mxCell が `edgeLabel` スタイルで生成されているか
  - `parent` が対象エッジの ID になっているか
  - `connectable="0"` が設定されているか

### 5-3. データベースシェイプの生成

- **入力**: 「アーキテクチャ図にDBサーバーをシリンダー型で追加して」
- **確認ポイント**:
  - `shape=cylinder3` スタイルが使われているか
  - fillColor/strokeColor がインフラ用の緑（#d5e8d4 / #82b366）になっているか

### 5-4. 要素の洗い出しステップ

- **入力**: 「受注管理システムのドメインモデル図を作って。注文、顧客、商品、配送を含めて」
- **確認ポイント**:
  - XML 生成前に、ボックス・関係性・グループの一覧を列挙するステップがあるか（SKILL.md 手順4）

## 6. XML 制約・エッジケース

> **横断検証**: セクション1・5で生成された全ての `.drawio` ファイルに対して、以下の制約が守られているかを確認する。

### 6-1. XML コメントに `--` が含まれないこと

- **入力**: エンティティ名に「Order」と「Customer」を含む図を作成
- **確認ポイント**:
  - `<!-- Order ---> Customer -->` のような NG パターンが生成されないか
  - `<!-- Order to Customer -->` のように `--` を避けた形式になっているか

### 6-2. darkMode="0" の付与

- **入力**: 1-1〜1-5 で作成した図の XML を確認
- **確認ポイント**:
  - 全ての `<mxGraphModel>` に `darkMode="0"` が設定されているか
- **注意**: draw.io デスクトップアプリがファイルを保存すると `darkMode="0"` 属性を除去する場合がある。スキルの生成時点で付与されていれば OK。アプリ保存後の XML ではなく、`Write`/`Edit` 直後の XML で確認すること

### 6-3. ID の一意性

- **入力**: 多数の要素を含む図を作成、またはエンティティを追加
- **確認ポイント**:
  - `box1`, `edge1` のようなプレフィックス付き ID で重複がないか
  - 編集時に既存 ID と衝突していないか

### 6-4. 改行文字

- **入力**: 「日本語名と英語名を併記したエンティティの図を作って」（例: 注文 / Order）
- **確認ポイント**:
  - ラベル内の改行が `&#xa;` で表現されているか

### 6-5. parent-child の座標計算

- **入力**: グループ（swimlane）内に子要素を配置する図を作成
- **確認ポイント**:
  - 子要素の座標が親からの相対座標になっているか
  - layout-guide.md の計算式に準拠しているか（絶対座標 = 親座標 + 相対座標）

### 6-6. vertex/edge 属性

- **入力**: 1-1〜1-5 で作成した図の XML を確認
- **確認ポイント**:
  - 図形（ボックス等）に `vertex="1"` が付いているか
  - 接続線に `edge="1"` が付いているか

## 7. レイアウト品質

> **横断検証**: セクション1・5で生成された図を draw.io デスクトップアプリで開き、視覚的にレイアウト品質を確認する。

### 7-1. 要素の重なりがないこと

- **入力**: 5つ以上のエンティティを含む図を作成
- **確認ポイント**:
  - 座標計算でボックス同士が重ならないこと
  - 適切な間隔が確保されていること

### 7-2. エッジの交差が最小限であること

- **入力**: 複数のリレーションを持つ図を作成
- **確認ポイント**:
  - 接続ポイント（exitX/exitY/entryX/entryY）が適切に分散されているか
  - エッジの交差が最小限に抑えられているか

### 7-3. レイアウト原則への準拠

- **入力**: ドメインモデル図を作成
- **確認ポイント**:
  - 垂直方向 = 親子関係（上が親、下が子）
  - 水平方向 = 集約関係
  - レイアウト原則に従っているか

### 7-4. サービス・リポジトリの配置

- **入力**: ドメインサービスとリポジトリを含むドメインモデル図を作成
- **確認ポイント**:
  - サービス・リポジトリが端（右側）に配置されているか
  - エッジの交差を避ける配置になっているか
